<div class="table-container">
  @if (!isExternalControlActive()) {
    <div class="search-container">
      <div class="search-controls">
        <select
          class="search-column-select"
          [value]="searchColumn() ?? ''"
          (change)="onSearchColumnChange($any($event.target).value)"
          aria-label="Select column to search"
        >
          <option value="">All Columns</option>
          @for (column of columns(); track column.key) {
            <option [value]="column.key">{{ column.header }}</option>
          }
        </select>
        <div class="search-input-wrapper">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            class="search-input"
            [placeholder]="searchPlaceholder()"
            [value]="searchQuery()"
            (input)="onSearchChange($any($event.target).value)"
          />
          @if (searchQuery()) {
            <button
              type="button"
              class="clear-button"
              (click)="clearSearch()"
              aria-label="Clear search"
            >
              ‚úï
            </button>
          }
        </div>
      </div>
      @if (searchQuery()) {
        <div class="search-results">
          Showing {{ filteredAndSortedData().length }} of {{ data().length }} results
          @if (selectedColumnHeader()) {
            <span class="search-column-badge">in {{ selectedColumnHeader() }}</span>
          }
        </div>
      }
    </div>
  }
  @if (selectionMode() === 'multiple') {
    <div class="selection-controls">
      <div class="selection-actions">
        <button
          type="button"
          class="select-all-button"
          (click)="selectAll()"
          [disabled]="filteredAndSortedData().length === 0"
        >
          Select All
        </button>
        <button
          type="button"
          class="deselect-all-button"
          (click)="deselectAll()"
          [disabled]="effectiveSelectedRows().size === 0"
        >
          Deselect All
        </button>
      </div>
      <div class="selection-count">
        {{ totalSelectedCount() }} of {{ data().length }} selected
      </div>
    </div>
  }
  <div class="table-toolbar">
    <div class="toolbar-spacer"></div>
    <div class="toolbar-right" style="position: relative;">
      <button
        type="button"
        class="column-picker-button"
        (click)="toggleColumnPicker()"
        aria-label="Toggle column visibility"
        [attr.aria-expanded]="showColumnPicker()"
      >
        <span class="column-picker-icon">‚öô</span>
        Columns
      </button>
      @if (showColumnPicker()) {
        <div class="column-picker-dropdown">
      <div class="column-picker-header">
        <h3>Toggle Columns</h3>
        <button
          type="button"
          class="close-picker-button"
          (click)="closeColumnPicker()"
          aria-label="Close column picker"
        >
          ‚úï
        </button>
      </div>
      <div class="column-picker-list">
        @for (column of orderedColumns(); track column.key; let idx = $index) {
          <label 
            class="column-picker-item"
            [class.dragging]="draggedColumnIndex() === idx"
            [class.drop-before]="shouldShowDropIndicator(idx) === 'before'"
            [class.drop-after]="shouldShowDropIndicator(idx) === 'after'"
            draggable="true"
            (dragstart)="onDragStart($event, idx)"
            (dragover)="onDragOver($event, idx)"
            (dragenter)="onDragEnter($event, idx)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event, idx)"
            (dragend)="onDragEnd()"
          >
            <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
            <input
              type="checkbox"
              [checked]="isColumnVisible(column.key)"
              (change)="toggleColumnVisibility(column.key)"
            />
            <span>{{ column.header }}</span>
          </label>
        }
      </div>
      </div>
      }
    </div>
  </div>
  <table class="data-table">
    <thead>
      <tr>
        @if (selectionMode() !== 'none') {
          <th class="selection-header">
            @if (selectionMode() === 'multiple') {
              <input
                type="checkbox"
                class="select-all-checkbox"
                [checked]="isAllSelected()"
                [attr.indeterminate]="isIndeterminate()"
                (change)="toggleSelectAll()"
                aria-label="Select all rows"
              />
            } @else {
              <span class="selection-header-text">Select</span>
            }
          </th>
        }
        @for (column of visibleColumns(); track column.key) {
          <th
            [class.sortable]="column.sortable"
            [class.sorted]="isSorted(column)"
            (click)="onSort(column)"
          >
            <span class="header-content">
              {{ column.header }}
              @if (column.sortable) {
                <span class="sort-icon" [class.active]="isSorted(column)">
                  {{ sortIcon(column) }}
                </span>
              }
            </span>
          </th>
        }
      </tr>
    </thead>
    <tbody>
      @if (filteredAndSortedData().length === 0) {
        <tr>
          <td [attr.colspan]="(selectionMode() !== 'none' ? 1 : 0) + visibleColumns().length" class="empty-message">
            @if (effectiveSearchQuery()) {
              No results found for "{{ effectiveSearchQuery() }}"
            } @else {
              No data available
            }
          </td>
        </tr>
      } @else {
        @for (row of paginatedData(); track getRowId(row)) {
          <tr [class.selected]="isRowSelected(row)">
            @if (selectionMode() !== 'none') {
              <td class="selection-cell">
                @if (selectionMode() === 'multiple') {
                  <input
                    type="checkbox"
                    class="row-checkbox"
                    [checked]="isRowSelected(row)"
                    (change)="toggleRowSelection(row)"
                    [attr.aria-label]="'Select row ' + getRowId(row)"
                  />
                } @else {
                  <input
                    type="radio"
                    class="row-radio"
                    [checked]="isRowSelected(row)"
                    (change)="toggleRowSelection(row)"
                    name="table-row-selection"
                    [attr.aria-label]="'Select row ' + getRowId(row)"
                  />
                }
              </td>
            }
            @for (column of visibleColumns(); track column.key) {
              <td>
                @if (column.cellTemplate) {
                  <ng-container
                    *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, column: column }"
                  ></ng-container>
                } @else {
                  {{ getCellValue(row, column) }}
                }
              </td>
            }
          </tr>
        }
      }
    </tbody>
  </table>

  @if (enablePagination() && totalPages() > 1) {
    <div class="pagination-container">
      <div class="pagination-info">
        Showing {{ pageInfo().startItem }} to {{ pageInfo().endItem }} of {{ pageInfo().totalItems }} entries
      </div>
      
      <div class="pagination-controls">
        <button
          type="button"
          class="pagination-button"
          [disabled]="pageInfo().currentPage === 1 || loading()"
          (click)="goToFirstPage()"
          aria-label="Go to first page"
        >
          ¬´
        </button>
        
        <button
          type="button"
          class="pagination-button"
          [disabled]="pageInfo().currentPage === 1 || loading()"
          (click)="goToPreviousPage()"
          aria-label="Go to previous page"
        >
          ‚Äπ
        </button>
        
        @for (pageNum of getVisiblePageNumbers(); track pageNum) {
          <button
            type="button"
            class="pagination-button"
            [class.active]="pageNum === pageInfo().currentPage"
            [disabled]="loading()"
            (click)="goToPage(pageNum)"
            [attr.aria-label]="'Go to page ' + pageNum"
          >
            {{ pageNum }}
          </button>
        }
        
        <button
          type="button"
          class="pagination-button"
          [disabled]="pageInfo().currentPage === pageInfo().totalPages || loading()"
          (click)="goToNextPage()"
          aria-label="Go to next page"
        >
          ‚Ä∫
        </button>
        
        <button
          type="button"
          class="pagination-button"
          [disabled]="pageInfo().currentPage === pageInfo().totalPages || loading()"
          (click)="goToLastPage()"
          aria-label="Go to last page"
        >
          ¬ª
        </button>
      </div>
    </div>
  }

  @if (loading()) {
    <div class="loading-overlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Loading...</span>
      </div>
    </div>
  }
</div>

